function App() {
    const [rates, setRates] = useState([]);
    const [showBannerModal, setShowBannerModal] = useState(false);
    const [bannerUrl, setBannerUrl] = useState(null);
    const [lastUpdate, setLastUpdate] = useState("");
    const [isLoading, setIsLoading] = useState(false);

    /* ========= å³æ™‚äººæ•¸ï¼ˆå¹³æ»‘æµ®å‹•ï¼‰ ========= */
    const [onlineCount, setOnlineCount] = useState(() => {
        const saved = localStorage.getItem("onlineCount");
        return saved ? parseInt(saved) : Math.floor(Math.random() * 80) + 180;
    });

    /* ========= ç´¯ç©äº¤æ˜“æ•¸ï¼ˆåªå¢ä¸æ¸›ï¼‰ ========= */
    const [transactionCount, setTransactionCount] = useState(() => {
        const saved = localStorage.getItem("transactionCount");
        if (saved) return parseInt(saved);
        localStorage.setItem("transactionCount", BASE_COUNT);
        return BASE_COUNT;
    });

    const canvasRef = useRef(null);

    /* ========= åŒ¯ç‡ ========= */
    const fetchRatesFromSheet = async () => {
        setIsLoading(true);
        try {
            const response = await fetch(SHEET_CSV_URL);
            const csvText = await response.text();
            const rows = csvText.split('\n').slice(1);
            const parsedData = rows.map(row => {
                const cols = row.split(',');
                if (cols.length >= 2) {
                    return {
                        name: cols[0].trim().replace(/^"|"$/g, ''),
                        value: cols[1].trim().replace(/^"|"$/g, '')
                    };
                }
                return null;
            }).filter(item => item && item.name);
            setRates(parsedData);
            updateLastSyncTime();
        } catch (error) {
            console.error("Fetch Error:", error);
        } finally {
            setIsLoading(false);
        }
    };

    /* ========= ç´¯ç©äº¤æ˜“æ•¸è‡ªå‹•æˆé•· ========= */
    useEffect(() => {
        fetchRatesFromSheet();

        const tradeTimer = setInterval(() => {
            const increase = Math.floor(Math.random() * 3) + 1; // +1~3
            setTransactionCount(prev => {
                const next = prev + increase;
                localStorage.setItem("transactionCount", next);
                return next;
            });
        }, 6000); // æ¯ 6 ç§’å¢åŠ ä¸€æ¬¡

        return () => clearInterval(tradeTimer);
    }, []);

    /* ========= å³æ™‚äººæ•¸å¹³æ»‘è®Šå‹• ========= */
    useEffect(() => {
        const onlineTimer = setInterval(() => {
            setOnlineCount(prev => {
                let change = Math.floor(Math.random() * 7) - 3; // -3 ~ +3
                let next = prev + change;
                next = Math.max(120, Math.min(380, next));
                localStorage.setItem("onlineCount", next);
                return next;
            });
        }, 5000);

        return () => clearInterval(onlineTimer);
    }, []);

    const updateLastSyncTime = () => {
        const now = new Date();
        setLastUpdate(now.toLocaleString('zh-TW', { hour12: false }));
    };

    /* ========= ç”¢ç”Ÿ Bannerï¼ˆä½ åŸæœ¬çš„ï¼‰ ========= */
    const generateBanner = () => {
        const canvas = canvasRef.current;
        const ctx = canvas.getContext('2d');

        const headerH = 300;
        const footerH = 300;
        const rowH = 60;
        const listPadding = 60;
        const contentH = (rates.length * rowH) + listPadding;

        canvas.width = 1200;
        canvas.height = headerH + contentH + footerH;

        ctx.fillStyle = '#020617';
        ctx.fillRect(0, 0, canvas.width, canvas.height);

        ctx.fillStyle = '#ffffff';
        ctx.font = 'bold 80px "Noto Sans TC"';
        ctx.textAlign = 'center';
        ctx.fillText('æ—¥å¤®æ°´æº', 600, 180);

        ctx.fillStyle = '#94a3b8';
        ctx.font = '30px "Noto Sans TC"';
        ctx.fillText('å°ˆæ¥­ NC å¤©å ‚å¤©å¹£å ±åƒ¹ç³»çµ±', 600, 240);

        ctx.strokeStyle = '#1e293b';
        ctx.lineWidth = 2;
        ctx.strokeRect(100, headerH, 1000, contentH);

        ctx.font = 'bold 32px "Noto Sans TC"';
        rates.forEach((item, i) => {
            const y = headerH + 65 + (i * rowH);
            ctx.textAlign = 'left';
            ctx.fillStyle = '#cbd5e1';
            ctx.fillText(item.name, 150, y);
            ctx.textAlign = 'right';
            ctx.fillStyle = '#3b82f6';
            ctx.fillText(item.value || 'è©¢å•å®¢æœ', 1050, y);
        });

        setBannerUrl(canvas.toDataURL('image/png'));
        setShowBannerModal(true);
    };

    /* ========= UI ä¸ç”¨å‹• ========= */
    return (
        /* ğŸ”´ ä½ åŸæœ¬ return çš„ JSXï¼Œå®Œå…¨ä¸ç”¨æ”¹ */
        /* é€™è£¡æˆ‘ä¸é‡è²¼ï¼Œé¿å…å¤ªé•· */
        window.__REACT_RENDER__
    );
}
