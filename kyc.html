import React, { useState, useEffect, useCallback, memo } from 'react';
import { initializeApp } from 'firebase/app';
import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from 'firebase/auth';
import { getFirestore, collection, addDoc, serverTimestamp } from 'firebase/firestore';


/**
 * SUNWATER KYC å°ˆæ¥­å®šç¨¿ç‰ˆ v4.0.0 (ç´” Firebase ç‰ˆ)
 * * ç‰ˆæœ¬æ‘˜è¦ï¼š
 * 1. ä»‹é¢è¦–è¦ºï¼šç¶“å…¸ v4.0 é›™æ­¥é©Ÿå¼•å°ï¼Œå·¥æ¥­æ·±è‰²èª¿ã€‚
 * 2. å®‰å…¨é˜²è­·ï¼šå½±åƒä¸Šå‚³è‡ªå‹•åŠ è¨»ã€Œä¾›æ—¥å¤®æ°´åŸäº¤æ˜“å¯©æ ¸ç”¨ã€æµ®æ°´å°ã€‚
 * 3. å„²å­˜é‚è¼¯ï¼šç§»é™¤ GAS ä¸²æ¥ï¼Œå°ˆæ³¨æ–¼ Firestore ç©©å®šå„²å­˜ã€‚
 */


// --- Firebase é…ç½® ---
const firebaseConfig = JSON.parse(__firebase_config);
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const appId = typeof __app_id !== 'undefined' ? __app_id : 'sunwater-kyc-official';


const InputField = memo(({ label, type = "text", placeholder, value, onChange, icon, error }) => (
  <div className="flex-1 min-w-[200px]">
    <label className="block text-[11px] font-bold text-slate-500 mb-2 ml-1 uppercase tracking-wider">{label}</label>
    <div className="relative">
      {icon && <span className="absolute left-4 top-1/2 -translate-y-1/2 text-slate-600 text-sm">{icon}</span>}
      <input
        type={type}
        className={`w-full bg-[#1c2128] border ${error ? 'border-red-500/50' : 'border-slate-800'} rounded-xl ${icon ? 'pl-10' : 'px-4'} py-3.5 focus:border-orange-500/50 focus:ring-1 focus:ring-orange-500/20 outline-none transition-all placeholder:text-slate-700 text-white text-sm`}
        placeholder={placeholder}
        value={value}
        onChange={(e) => onChange(e.target.value)}
      />
    </div>
    {error && <p className="text-[10px] text-red-500 mt-1 ml-1 font-bold">{error}</p>}
  </div>
));


const App = () => {
  const [user, setUser] = useState(null);
  const [loading, setLoading] = useState(false);
  const [submitted, setSubmitted] = useState(false);
  const [error, setError] = useState('');
  const [currentStep, setCurrentStep] = useState(1);
 
  const [checks, setChecks] = useState({
    nameMatch: false,
    qualityOk: false
  });
 
  const [formData, setFormData] = useState({
    name: '',
    gender: 'ç”·',
    birthDate: '',
    birthPlace: '',
    idNumber: '',
    idExpiry: '',
    email: '',
    phone: '',
    bankName: '',
    bankAccount: '',
    idFront: '',
    idBack: '',
    bankPassbook: ''
  });


  const WATERMARK_TEXT = "ä¾›æ—¥å¤®æ°´åŸäº¤æ˜“å¯©æ ¸ç”¨";


  // --- åˆå§‹åŒ– Firebase èªè­‰ (Rule 3) ---
  useEffect(() => {
    const initAuth = async () => {
      try {
        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
          await signInWithCustomToken(auth, __initial_auth_token);
        } else {
          await signInAnonymously(auth);
        }
      } catch (err) { console.error("Firebase Auth Error:", err); }
    };
    initAuth();
    const unsubscribe = onAuthStateChanged(auth, setUser);
    return () => unsubscribe();
  }, []);


  const handleInputChange = useCallback((field, value) => {
    setFormData(prev => ({ ...prev, [field]: value }));
  }, []);


  // --- åœ–ç‰‡è™•ç†èˆ‡æµ®æ°´å°æ³¨å…¥ ---
  const processImage = (file, fieldName) => {
    if (!file) return;
    const reader = new FileReader();
    reader.onload = (e) => {
      const img = new Image();
      img.onload = () => {
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');
        const scale = Math.min(1000 / img.width, 1);
        canvas.width = img.width * scale;
        canvas.height = img.height * scale;
        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
       
        ctx.font = `bold ${canvas.width / 15}px sans-serif`;
        ctx.fillStyle = "rgba(251, 146, 60, 0.35)";
        ctx.textAlign = "center";
       
        // ç¹ªè£½å°è§’ç·šæµ®æ°´å°çŸ©é™£
        for(let x=0; x<=canvas.width; x+=canvas.width/2.5) {
          for(let y=0; y<=canvas.height; y+=canvas.height/3.5) {
            ctx.save();
            ctx.translate(x, y);
            ctx.rotate(-Math.PI / 6);
            ctx.fillText(WATERMARK_TEXT, 0, 0);
            ctx.restore();
          }
        }
        setFormData(prev => ({ ...prev, [fieldName]: canvas.toDataURL('image/jpeg', 0.6) }));
        setError("");
      };
      img.src = e.target.result;
    };
    reader.readAsDataURL(file);
  };


  const handleFileChange = (e, key) => {
    const file = e.target.files[0];
    if (file) processImage(file, key);
  };


  const validateStep1 = () => {
    const idRegex = /^[A-Z][12]\d{8}$/;
    if (!formData.name || formData.name.length < 2) {
      setError("æ ¸å°è³‡è¨Šæœ‰èª¤ï¼šè«‹å¡«å¯«æ­£ç¢ºä¹‹çœŸå¯¦å§“åã€‚");
      return false;
    }
    if (!idRegex.test(formData.idNumber)) {
      setError("æ ¸å°è³‡è¨Šæœ‰èª¤ï¼šè­‰ä»¶è™Ÿç¢¼æ ¼å¼ä¸ç¬¦ï¼ˆé ˆç‚ºå¤§å¯«è‹±æ–‡å­—æ¯é–‹é ­ï¼‰ã€‚");
      return false;
    }
    setError('');
    return true;
  };


  const handleSubmit = async (e) => {
    e.preventDefault();
    if (!formData.bankName || !formData.bankAccount || !formData.idFront || !formData.idBack || !formData.bankPassbook) {
      setError("æ ¸å°è³‡è¨Šæœ‰èª¤ï¼šè«‹å®Œæˆæ‰€æœ‰å¿…è¦è­‰ä»¶å½±åƒä¸Šå‚³ã€‚");
      return;
    }
    const allChecked = Object.values(checks).every(v => v);
    if (!allChecked) {
      setError("æ ¸å°è³‡è¨Šæœ‰èª¤ï¼šè«‹ç¢ºå¯¦å‹¾é¸ä¸‹æ–¹å®£å‘Šã€‚");
      return;
    }


    setLoading(true);
    setError('');


    try {
      // å„²å­˜è‡³ Firestore (Rule 1: Strict Paths)
      if (user) {
        const kycRef = collection(db, 'artifacts', appId, 'public', 'data', 'submissions');
        await addDoc(kycRef, {
          ...formData,
          userId: user.uid,
          submittedAt: serverTimestamp()
        });
        setSubmitted(true);
      } else {
        throw new Error("èªè­‰å¤±æ•ˆï¼Œè«‹é‡æ–°æ•´ç†é é¢ã€‚");
      }
    } catch (err) {
      console.error("Firestore Error:", err);
      setError('å„²å­˜è‡³é›²ç«¯æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹æª¢æŸ¥ç¶²è·¯ç‹€æ…‹ã€‚');
    } finally {
      setLoading(false);
    }
  };


  if (submitted) {
    return (
      <div className="min-h-screen bg-[#0d1117] flex items-center justify-center p-6 text-white font-sans">
        <div className="max-w-md w-full bg-[#161b22] border border-orange-500/30 rounded-3xl p-12 text-center shadow-2xl">
          <div className="w-20 h-20 bg-orange-500 text-black rounded-full flex items-center justify-center mx-auto mb-6">
            <svg className="w-12 h-12" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="4" d="M5 13l4 4L19 7"></path></svg>
          </div>
          <h2 className="text-3xl font-black mb-2 tracking-tight uppercase italic text-white">Verified</h2>
          <p className="text-slate-400 mb-8 text-sm">èº«åˆ†æ ¸å°ç¨‹åºå·²å®Œæˆï¼Œè³‡æ–™å·²å®‰å…¨å„²å­˜ã€‚</p>
          <button onClick={() => window.location.reload()} className="w-full py-4 bg-slate-800 hover:bg-slate-700 text-white rounded-xl font-bold transition-all uppercase tracking-widest text-xs">EXIT SESSION</button>
        </div>
      </div>
    );
  }


  return (
    <div className="min-h-screen bg-[#0d1117] text-slate-100 pb-20 font-sans">
      <header className="py-6 px-6 text-center border-b border-slate-800/50 bg-[#161b22]/80 backdrop-blur-md sticky top-0 z-50">
        <h1 className="text-xl font-black tracking-tighter italic uppercase text-white">
          SUNWATER <span className="text-orange-500">KYC</span>
        </h1>
      </header>


      <main className="max-w-2xl mx-auto mt-8 px-4">
        {/* Step Indicator */}
        <div className="flex mb-8 bg-[#161b22] rounded-full overflow-hidden border border-slate-800 h-1">
            <div className={`transition-all duration-500 ease-out h-full ${currentStep === 1 ? 'w-1/2 bg-white' : 'w-full bg-white'}`}></div>
        </div>
        <div className="flex justify-between px-2 mb-4">
            <span className={`text-[10px] font-black uppercase tracking-widest ${currentStep === 1 ? 'text-white' : 'text-slate-600'}`}>Step 01 / Info</span>
            <span className={`text-[10px] font-black uppercase tracking-widest ${currentStep === 2 ? 'text-white' : 'text-slate-600'}`}>Step 02 / Files</span>
        </div>


        <div className="bg-[#161b22] border border-slate-800/50 rounded-[2rem] overflow-hidden shadow-2xl">
          {error && <div className="bg-red-500/10 border-b border-red-500/20 text-red-400 p-4 text-center text-[11px] font-black uppercase tracking-widest animate-pulse">{error}</div>}
         
          <div className="p-6 md:p-10">
            {currentStep === 1 ? (
              <div className="space-y-8 animate-in fade-in duration-300">
                <div>
                  <h2 className="text-2xl font-black text-white italic">åŸºæœ¬è³‡æ–™æ ¸å°</h2>
                  <p className="text-slate-500 text-xs mt-2 font-medium">è«‹ä¾ç…§æ‚¨çš„èº«åˆ†è­‰ä»¶å…§å®¹å¦‚å¯¦å¡«å¯«ã€‚</p>
                </div>
               
                <div className="grid grid-cols-1 md:grid-cols-2 gap-8">
                  <InputField label="å®Œæ•´å§“å (ä¸­/è‹±)" placeholder="è«‹è¼¸å…¥å§“å" value={formData.name} onChange={val => handleInputChange('name', val)} />
                  <div className="flex-1">
                    <label className="block text-[11px] font-bold text-slate-500 mb-4 uppercase tracking-wider">æ€§åˆ¥</label>
                    <div className="flex gap-4">
                      {['ç”·', 'å¥³'].map(g => (
                        <label key={g} className="flex items-center gap-2 cursor-pointer group">
                          <input type="radio" name="gender" checked={formData.gender === g} onChange={() => handleInputChange('gender', g)} className="w-4 h-4 border-slate-800 bg-slate-900 text-orange-500 focus:ring-0" />
                          <span className={`text-sm font-bold ${formData.gender === g ? 'text-white' : 'text-slate-500 group-hover:text-slate-300'}`}>{g}</span>
                        </label>
                      ))}
                    </div>
                  </div>
                  <InputField label="å‡ºç”Ÿæ—¥æœŸ" type="date" value={formData.birthDate} onChange={val => handleInputChange('birthDate', val)} />
                  <InputField label="å‡ºç”Ÿåœ°" placeholder="ä¾‹å¦‚ï¼šå°åŒ—å¸‚" value={formData.birthPlace} onChange={val => handleInputChange('birthPlace', val)} />
                  <InputField label="èº«åˆ†è­‰ / è­·ç…§è™Ÿç¢¼" placeholder="A123456789" value={formData.idNumber} onChange={val => handleInputChange('idNumber', val)} />
                  <InputField label="è­‰ä»¶æœ‰æ•ˆæœŸé™" type="date" value={formData.idExpiry} onChange={val => handleInputChange('idExpiry', val)} />
                  <InputField label="é›»å­éƒµä»¶" type="email" placeholder="email@example.com" value={formData.email} onChange={val => handleInputChange('email', val)} />
                  <InputField label="æ‰‹æ©Ÿè™Ÿç¢¼" placeholder="0912345678" value={formData.phone} onChange={val => handleInputChange('phone', val)} />
                </div>
                <button onClick={() => validateStep1() && setCurrentStep(2)} className="w-full mt-4 py-4 bg-black text-white border border-slate-700 rounded-xl font-black text-sm uppercase tracking-[0.3em] hover:bg-orange-500 hover:text-black transition-all flex items-center justify-center gap-2 active:scale-[0.98]">
                  ä¸‹ä¸€æ­¥ <span className="text-lg">&gt;</span>
                </button>
              </div>
            ) : (
              <div className="space-y-8 animate-in fade-in slide-in-from-bottom-4 duration-500">
                <div>
                  <h2 className="text-2xl font-black text-white italic">éŠ€è¡Œè³‡è¨Šèˆ‡è­‰æ˜æ–‡ä»¶</h2>
                  <p className="text-slate-500 text-xs mt-2 font-medium">è«‹æä¾›æ‚¨çš„å…¥é‡‘/ææ¬¾éŠ€è¡Œå¸³è™Ÿï¼Œä¸¦ä¸Šå‚³ç›¸é—œè­‰æ˜ã€‚</p>
                </div>
               
                <div className="grid grid-cols-1 md:grid-cols-2 gap-6 bg-[#0d1117] p-6 rounded-3xl border border-slate-800/50 shadow-inner">
                  <InputField label="ğŸ› éŠ€è¡Œåç¨±" placeholder="ä¾‹å¦‚ï¼šå°ç£éŠ€è¡Œ" value={formData.bankName} onChange={val => handleInputChange('bankName', val)} />
                  <InputField label="ğŸ’³ éŠ€è¡Œå¸³è™Ÿ" placeholder="è«‹è¼¸å…¥å¸³è™Ÿ" value={formData.bankAccount} onChange={val => handleInputChange('bankAccount', val)} />
                </div>


                <div className="space-y-4">
                  <div className="bg-orange-500/5 border border-orange-500/20 rounded-2xl p-4 flex items-start gap-3">
                    <svg className="w-5 h-5 text-orange-500 mt-0.5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M12 15v2m0 0v3m0-3h3m-3 0H9m12-3a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                    <p className="text-[11px] leading-relaxed text-slate-400 font-medium">
                      <span className="text-orange-500 font-black">è³‡è¨Šå®‰å…¨å‘ŠçŸ¥ï¼š</span>ç³»çµ±å°‡è‡ªå‹•æ–¼ä¸Šå‚³å½±åƒåŠ è¨»<span className="text-white italic">ã€Œä¾›æ—¥å¤®æ°´åŸäº¤æ˜“å¯©æ ¸ç”¨ã€</span>é˜²è­·æµ®æ°´å°ï¼Œç¢ºä¿è³‡è¨Šåƒ…ä¾›æœ¬æ¬¡å¯©æ ¸ä½¿ç”¨ã€‚
                    </p>
                  </div>


                  <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                    {[
                      { id: 'idFront', label: 'èº«åˆ†è­‰æ­£é¢' },
                      { id: 'idBack', label: 'èº«åˆ†è­‰åé¢' },
                      { id: 'bankPassbook', label: 'å­˜æ‘ºå°é¢' }
                    ].map(item => (
                      <div key={item.id} className="relative aspect-[4/3] bg-[#0d1117] border border-slate-800 rounded-2xl flex flex-col items-center justify-center overflow-hidden transition-all group hover:border-orange-500/50">
                        <input type="file" accept="image/*" onChange={e => handleFileChange(e, item.id)} className="absolute inset-0 opacity-0 z-20 cursor-pointer" />
                        {formData[item.id] ? (
                          <img src={formData[item.id]} className="w-full h-full object-cover" />
                        ) : (
                          <div className="text-center p-4">
                            <svg className="w-6 h-6 mx-auto mb-2 text-slate-600 group-hover:text-orange-500 transition-colors" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M4 16v1a2 2 0 002 2h12a2 2 0 002-2v-1m-4-8l-4-4m0 0L8 8m4-4v12" /></svg>
                            <span className="text-[10px] font-bold text-slate-500 uppercase">{item.label}</span>
                          </div>
                        )}
                      </div>
                    ))}
                  </div>
                </div>


                <div className="bg-[#0d1117] border border-slate-800 rounded-2xl p-6 space-y-3">
                  <p className="text-[10px] font-black text-orange-500 uppercase tracking-widest mb-3 opacity-80 italic">Verification Declaration</p>
                  {[
                    { key: 'nameMatch', text: 'æœ¬äººåœ¨æ­¤å®£å‘Šï¼Œä»¥ä¸Šæ‰€æä¾›çš„è³‡æ–™å‡ç‚ºçœŸå¯¦ä¸”æ­£ç¢ºã€‚' },
                    { key: 'qualityOk', text: 'å½±åƒå“è³ªæ¸…æ™°ã€ç„¡åå…‰ä¸”ç„¡ä»»ä½•é®æ“‹ã€‚' }
                  ].map(check => (
                    <label key={check.key} className="flex items-center gap-3 cursor-pointer group">
                      <input type="checkbox" className="w-4 h-4 rounded border-slate-800 bg-slate-900 text-orange-500 focus:ring-0" checked={checks[check.key]} onChange={e => setChecks({...checks, [check.key]: e.target.checked})} />
                      <span className={`text-[11px] font-bold ${checks[check.key] ? 'text-white' : 'text-slate-500'}`}>{check.text}</span>
                    </label>
                  ))}
                </div>


                <div className="flex gap-4">
                  <button onClick={() => setCurrentStep(1)} className="flex-1 py-4 bg-transparent border border-slate-800 hover:bg-slate-800 text-slate-400 rounded-xl font-black text-sm uppercase tracking-widest transition-all">BACK</button>
                  <button onClick={handleSubmit} disabled={loading} className={`flex-[2] py-4 rounded-xl font-black text-sm uppercase tracking-widest transition-all flex items-center justify-center gap-2 shadow-lg ${loading ? 'bg-slate-700 text-slate-500 cursor-not-allowed' : 'bg-white text-black hover:bg-orange-500 active:scale-[0.98]'}`}>
                    <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="3" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8" /></svg>
                    {loading ? 'SUBMITTING...' : 'SUBMIT'}
                  </button>
                </div>
              </div>
            )}
          </div>
        </div>
      </main>
    </div>
  );
};


export default App;

